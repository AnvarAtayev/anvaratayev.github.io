<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns="http://www.w3.org/1999/xhtml" xmlns:x="https://www.texmacs.org/2002/extensions">
  <head>
    <title>No title</title>
    <meta content="TeXmacs 1.99.21" name="generator"></meta>
    <style type="text/css">
      body { text-align: justify } h5 { display: inline; padding-right: 1em }
      h6 { display: inline; padding-right: 1em } table { border-collapse:
      collapse } td { padding: 0.2em; vertical-align: baseline } dt { float:
      left; min-width: 1.75em; text-align: right; padding-right: 0.75em;
      font-weight: bold; } dd { margin-left: 2.75em; padding-bottom: 0.25em; }
      dd p { padding-top: 0em; } .subsup { display: inline; vertical-align:
      -0.2em } .subsup td { padding: 0px; text-align: left} .fraction {
      display: inline; vertical-align: -0.8em } .fraction td { padding: 0px;
      text-align: center } .wide { position: relative; margin-left: -0.4em }
      .accent { position: relative; margin-left: -0.4em; top: -0.1em }
      .title-block { width: 100%; text-align: center } .title-block p {
      margin: 0px } .compact-block p { margin-top: 0px; margin-bottom: 0px }
      .left-tab { text-align: left } .center-tab { text-align: center }
      .balloon-anchor { border-bottom: 1px dotted #000000; outline: none;
      cursor: help; position: relative; } .balloon-anchor [hidden] {
      margin-left: -999em; position: absolute; display: none; }
      .balloon-anchor: hover [hidden] { position: absolute; left: 1em; top:
      2em; z-index: 99; margin-left: 0; width: 500px; display: inline-block; }
      .balloon-body { } .ornament { border-width: 1px; border-style: solid;
      border-color: black; display: inline-block; padding: 0.2em; } .right-tab
      { float: right; position: relative; top: -1em; } .no-breaks {
      white-space: nowrap; } 
    </style>
    <link href="../resources/notes-base.css" type="text/css" rel="stylesheet"></link>
  </head>
  <body>
    <p>
      
    </p>
    <p>
      
    </p>
    <p>
      
    </p>
    <p>
      [last revision: 2020.11.9]
    </p>
    <p>
      Let us see how Joris implemented a preview for link target in <a href="https://svn.savannah.gnu.org/viewvc/texmacs?view=revision&amp;revision=13081">r13081</a>.
      This requires adding new functionalities at several levels.
    </p>
    <p>
      Preview have to be shown in a popup balloon as soon as the user hovers
      the associate reference locus with the mouse. So we need to modify the 
      and  tags. There are &ldquo;primitive&rdquo; tags defined in the  source
      <code>src/Typeset/Env/env_default.cpp</code> with
    </p>
    <p>
      
    </p>
    <p>
      A new package at <code>packages/utilities/preview-ref.ts</code>
      containing a redefinition of the  and  tags:
    </p>
    <p>
      
    </p>
    <p>
      Note the use of the  tag to indicate that the  module  must be made
      available to TeXmacs beforehand in order to be able to call the 
      procedure . The module , defined in the  source
      <code>/progs/link/ref-edit.scm</code>, being with
    </p>
    <p>
      
    </p>
    <p>
      and contains the definition of  as a  (i.e. a global symbol visible in
      all the program). Note the  which indicates to TeXmacs that this
      producedure does not perform any <i>dangerous</i> operation and
      therefore can be called without notifying the user.
    </p>
    <p>
      
    </p>
    <p>
      This procedure invoke  to display a popup to the user which contains a
      widget to output TeXmacs documents (built via ) after suitably scaling
      it via a  tag. The content itself is produced by the procedure  :
    </p>
    <p>
      
    </p>
    <p>
      which in turn calls the helper procedure  (internal to the module):
    </p>
    <p>
      
    </p>
    <p>
      The construction of the preview content is performed by the snippet 
      which evaluates to a TeXmacs s-tree containing a singe  tag for the
      rendering of the preview. This is defined at the macro language level in
      <code>packages/standard/std-fold.ts</code> as
    </p>
    <p>
      
    </p>
    <p>
      This markup provides a custom style  and background color for the
      preview area, including a minimum width. 
    </p>
    <p>
      The <font color="brown"><i>body</i></font> argument is feed with a meaningful
      snippet of the source of the link. This is determined by the  procedure
      by navigating the document tree from the source position (as indicated
      by the  parameter) towards higher levels of the structure hierarchy via
      . The predicate  looks for meaningful context: a row of a table or a
      leaf of a  tag:
    </p>
    <p>
      
    </p>
    <p>
      We want also to include some major markup in the preview, e.g. theorems,
      etc
    </p>
    <p>
      
    </p>
    <p>
      The procedure  preforms some recursive cleaning on the source snippet:
    </p>
    <p>
      
    </p>
    <p>
      
    </p>
  </body>
</html>