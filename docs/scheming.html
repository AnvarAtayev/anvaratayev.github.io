<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns="http://www.w3.org/1999/xhtml" xmlns:x="https://www.texmacs.org/2002/extensions">
  <head>
    <title>No title</title>
    <meta content="TeXmacs 1.99.21" name="generator"></meta>
    <style type="text/css">
      body { text-align: justify } h5 { display: inline; padding-right: 1em }
      h6 { display: inline; padding-right: 1em } table { border-collapse:
      collapse } td { padding: 0.2em; vertical-align: baseline } dt { float:
      left; min-width: 1.75em; text-align: right; padding-right: 0.75em;
      font-weight: bold; } dd { margin-left: 2.75em; padding-bottom: 0.25em; }
      dd p { padding-top: 0em; } .subsup { display: inline; vertical-align:
      -0.2em } .subsup td { padding: 0px; text-align: left} .fraction {
      display: inline; vertical-align: -0.8em } .fraction td { padding: 0px;
      text-align: center } .wide { position: relative; margin-left: -0.4em }
      .accent { position: relative; margin-left: -0.4em; top: -0.1em }
      .title-block { width: 100%; text-align: center } .title-block p {
      margin: 0px } .compact-block p { margin-top: 0px; margin-bottom: 0px }
      .left-tab { text-align: left } .center-tab { text-align: center }
      .balloon-anchor { border-bottom: 1px dotted #000000; outline: none;
      cursor: help; position: relative; } .balloon-anchor [hidden] {
      margin-left: -999em; position: absolute; display: none; }
      .balloon-anchor: hover [hidden] { position: absolute; left: 1em; top:
      2em; z-index: 99; margin-left: 0; width: 500px; display: inline-block; }
      .balloon-body { } .ornament { border-width: 1px; border-style: solid;
      border-color: black; display: inline-block; padding: 0.2em; } .right-tab
      { float: right; position: relative; top: -1em; } .no-breaks {
      white-space: nowrap; } 
    </style>
    <link href="../resources/notes-base.css" type="text/css" rel="stylesheet"></link>
  </head>
  <body>
    <p>
      
    </p>
    <p>
      
    </p>
    <p>
      
    </p>
    <p>
      
    </p>
    <p>
      [6.1.2021]
    </p>
    <p>
      In TeXmacs we use <a href="https://www.gnu.org/software/guile/">GNU Guile</a> version 1.8 as embedded Scheme
      interpreter. Lately, this has been a source of problems, mostly related
      to packaging. On one hand Guile1.8 is no more supported in standard
      Linux distributions. This implies that we have either to ship Guile in
      our codebase or maintain a private repository for Guile1.8. On the other
      hand more recent versions of Guile compile the sources to bytecode and
      introduce a separated expansion and evaluation phases which break part
      of our codebase. Moreover while Guile2 has a fine compiler, it has been
      for some time quite slow in interpreting code and only recently with the
      introduction of a JIT compiler in Guile3 the interpreted code runs as
      fast as in Guile1.8. Finally we have some difficulties in compiling
      Guile2 on Windows and Guile3 seems not yet be supported there. The <a
      href="http://lilypond.org">GNU Lilypond</a> project seems to have run into similar issues
      with Guile and they also remained with Guile 1.8.8 (see <a href="http://lilypond.org/doc/v2.21/Documentation/contributor/requirements-for-running-lilypond">here</a>).
    </p>
    <p>
      This situation is not very nice and we would like to move forward and
      remove these problems. Therefore we are currently evaluating various
      possible strategies to evolve the way we run Scheme code within TeXmacs.
      The following are the criteria we want to take into account.
    </p>
    <ul>
      <li>
        <p>
          We use Scheme as an extension language to run on top of the GUI and
          the typesetting code in order to implement the dynamical and
          programmable UI. Additionally, if the implementation speed allows we
          can shift some of the conversion code in Scheme. We have C++ at our
          disposal anyway so we can always drop there for speed-critical
          tasks, but is nicer to be able to write Scheme code instead of C++.
        </p>
      </li>
      <li>
        <p>
          TeXmacs already needs a huge library like  in order to be
          cross-platform, so in this respect we would like not to carry over a
          huge all-purpose Scheme implementation which would come with all its
          own libraries dependencies (e.g. Guile needs GMP).
        </p>
      </li>
      <li>
        <p>
          We need to be cross-platform so we would like to minimize the
          problem related to porting the Scheme implementation on the various
          OSs and architectures.
        </p>
      </li>
      <li>
        <p>
          Guile 1.8 speed is OK so far. However we cannot loose performance
          (especially at boot time and for standard operations like moving the
          cursor around). We could even hope to gain some speed by using an
          alternative implementation.
        </p>
      </li>
      <li>
        <p>
          TeXmacs do not currently use Unicode for its internal string
          representations but a custom formate (TeXmacs universal
          representation), so marshaling data to Unicode-aware Schemes is a
          mildly issue for us.
        </p>
      </li>
    </ul>
    <p>
      As for the available alternatives, the situation so far is the
      following.
    </p>
    <ul>
      <li>
        <p>
          An easy choice would be to just integrate in our codebase the
          sources of Guile 1.8 (which is not more maintained) in TeXmacs. This
          would not require changes to our scheme code. However the packaging
          problems remains, moreover there are large portions of the library
          we do not use. 
        </p>
      </li>
      <li>
        <p>
          We can go with Guile3 and get the nice speed improvement wrt.1.8.
          See <a href="https://www.wingolog.org/archives/2020/06/03/a-baseline-compiler-for-guile">here</a> for some updates on the development of Guile.
          This will require more or less extensive changes to our Scheme code.
          These changes are been implemented in a git development branch and
          so far the situation seems promising. One drawback of this choice is
          the fact that support for platforms like Windows is not the primary
          goal of the Guile developers (as far as we understand) and also that
          Guile is become a large standalone scheme with many library
          dependencies, far from its origin as <i>extension language</i>. So
          the benefits of the compiler should be weighted against the
          difficulty of packaging and also the stability of the cross-platform
          support. Also Guile2/3 has encoding-aware strings which poses a
          (small) problem for us and would require some hackery to get around.
        </p>
      </li>
      <li>
        <p>
          An attractive option is to switch to another small, embeddable
          Scheme interpreter like <a href="https://github.com/ashinn/chibi-scheme/"> Scheme</a> or <a href="https://cm-gitlab.stanford.edu/bil/s7.git">S7
          Scheme</a>. For performance reasons it seems that the clear winner
          for us is S7 which is a very compact interpreter written in C with
          no external dependencies. We are currently experimenting in
          integrating S7 with TeXmacs and we have a working development branch
          (with still some issue).
        </p>
      </li>
      <li>
        <p>
          A radical alternative is to consider the embedding of a full-fledged
          Scheme compiler. By looking at the multitude of Scheme
          implementations around we singled out <a href="https://github.com/cisco/chezscheme"></a> as a compiled
          system which seems flexible enough to be able to be embedded in our
          setting. Its main features are: compactness, speed, industrial
          quality, open-source (Apache 2.0), cross-platform and with no
          external dependencies. (For an interesting history of this
          implementation refer to <a href="http://www.cs.indiana.edu/~dyb/pubs/hocs.pdf">this paper</a>.)
        </p>
      </li>
    </ul>
    <p>
      The development branches of TeXmacs for Guile 3 and S7 can be found
      here:
    </p>
    <ul>
      <li>
        <p>
          
        </p>
      </li>
      <li>
        <p>
          
        </p>
      </li>
    </ul>
    <p>
      We performed some test of these alternative implementations to help us
      make a preliminary picture. We used some standard R7RS benchmarks found
      <a href="https://github.com/ecraven/r7rs-benchmarks">here</a> and we got the results shown below on a MacBook Air
      (2019). They show that S7 is consistently the fastest interpreter wrt.
      Chibi or Guile 1.8. We also see that, as expected, Chez is among the
      fastest implementations available with consistent timings all across the
      benchmarks.
    </p>
    <p>
      We currently have working implementations of TeXmacs with Guile 1.8, S7
      and Guile 3.0.4 and what we see from preliminary tests is that boot time
      of S7 is comparable to that of Guile 3.0.4 (0.4 sec) and half of that of
      Guile 1.8 (0.8 sec). Also compile the full manual require the roughly
      the same time to all the three implementations (~15 sec). We would need
      to consider more intensive tests to discriminate the tradeoffs in
      performances of the various choices.
    </p>
    <p>
      Here are the results of the R7RS benchmarks. The symbol &empty; denotes
      that the program exceeded a conventional time limit and was interrupted.
    </p>
    <center>
      <p>
        
      </p>
    </center>
    <p>
      
    </p>
    <p>
      <hr></hr>
    </p>
    <p>
      [8.1.2021]
    </p>
    <p>
      Some more benchmarks. Populating the autocompletion tree (i.e. pressing 
      in a Scheme session within TeXmacs)
    </p>
    <center>
      <p>
        
      </p>
    </center>
    <p>
      
    </p>
    <p>
      <hr></hr>
    </p>
    <p>
      [12.4.2021]
    </p>
    <p>
      Another interesting system is <a href="https://github.com/JeffBezanson/femtolisp">femtolisp</a> which is currenlty
      in use within Julia for the initial stage of parsing and syntactic
      elaboration. It is a small lisp with lexical scoping and bytecode
      interpreter. The benchmarks have been updated to include it. S7 seems
      still faster on average.
    </p>
    <p>
      
    </p>
    <center>
      <p>
        
      </p>
    </center>
    <p>
      
    </p>
    <p>
      
    </p>
  </body>
</html>