<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns="http://www.w3.org/1999/xhtml" xmlns:x="https://www.texmacs.org/2002/extensions">
  <head>
    <title>No title</title>
    <meta content="TeXmacs 1.99.21" name="generator"></meta>
    <style type="text/css">
      body { text-align: justify } h5 { display: inline; padding-right: 1em }
      h6 { display: inline; padding-right: 1em } table { border-collapse:
      collapse } td { padding: 0.2em; vertical-align: baseline } dt { float:
      left; min-width: 1.75em; text-align: right; padding-right: 0.75em;
      font-weight: bold; } dd { margin-left: 2.75em; padding-bottom: 0.25em; }
      dd p { padding-top: 0em; } .subsup { display: inline; vertical-align:
      -0.2em } .subsup td { padding: 0px; text-align: left} .fraction {
      display: inline; vertical-align: -0.8em } .fraction td { padding: 0px;
      text-align: center } .wide { position: relative; margin-left: -0.4em }
      .accent { position: relative; margin-left: -0.4em; top: -0.1em }
      .title-block { width: 100%; text-align: center } .title-block p {
      margin: 0px } .compact-block p { margin-top: 0px; margin-bottom: 0px }
      .left-tab { text-align: left } .center-tab { text-align: center }
      .balloon-anchor { border-bottom: 1px dotted #000000; outline: none;
      cursor: help; position: relative; } .balloon-anchor [hidden] {
      margin-left: -999em; position: absolute; display: none; }
      .balloon-anchor: hover [hidden] { position: absolute; left: 1em; top:
      2em; z-index: 99; margin-left: 0; width: 500px; display: inline-block; }
      .balloon-body { } .ornament { border-width: 1px; border-style: solid;
      border-color: black; display: inline-block; padding: 0.2em; } .right-tab
      { float: right; position: relative; top: -1em; } .no-breaks {
      white-space: nowrap; } 
    </style>
    <link href="../resources/notes-base.css" type="text/css" rel="stylesheet"></link>
  </head>
  <body>
    <p>
      
    </p>
    <p>
      
    </p>
    <p>
      
    </p>
    <p>
      
    </p>
    <p>
      
    </p>
    <p>
      The basic idea is to have a markup element to insert comments in
      documents. There should be facilities to hide/show all comments and
      remove all comments. Hidden comments do not affect the typesetting of
      the document and are shown via a flag, but can still be read via
      balloons which opens as the cursor is nearby a comment.
    </p>
    <p>
      Here's an example of a document with two comments:
    </p>
    <p>
      <img class="image" src="comments-in-texmacs-1.png" width="100%"></img>
    </p>
    <p>
      and here the same document with both comments hidden, showing the
      balloon the user sees when the cursor is nearby an hidden comment
      (indicated by a flag, here shown in the &ldquo;detailed&rdquo; mode).
    </p>
    <p>
      <img class="image" src="comments-in-texmacs-2.png" width="100%"></img>
    </p>
    <p>
      
    </p>
    <p>
      We discuss the implementation of the basic functionality: comment tags
      and commands to operate on them. The first thing is to create a new
      package which the user has to include in the document in order to
      activate this feature. The package can be found in . First we make sure
      that the appropriate menu is loaded as soon as the package become
      active. Menus are created and managed via Scheme code, so we load the
      scheme module  which is found in the file :
    </p>
    <p>
      
    </p>
    <p>
      The module contains several macros, but the main interface is provided
      by the  and  macros:
    </p>
    <p>
      
    </p>
    <p>
      
    </p>
    <p>
      We will enter later into the specific details of the implementation.
      Both macros collect various arguments <font color="brown"><i>unique-id</i></font>,
      <font color="brown"><i>mirror-id</i></font>, <font color="brown"><i>type</i></font>,
      <font color="brown"><i>by</i></font>, <font color="brown"><i>time</i></font>, <font
      color="brown"><i>body</i></font>. While  renders the comment <font color="brown"><i>body</i></font>
      as part of the document, with an indication of the author, as provided
      by the argument <font color="brown"><i>by</i></font>, the  markup does not show
      up in the document directly since the evaluation of the associated macro
      results in a  element together with the <font color="brown"><i>body</i></font>
      of the comment inside an  element. We will discuss later on the role of
      the  which wraps the content in both cases.
    </p>
    <p>
      The  and  elements provide the functional, descriptive side of the
      comment functionality. They are the &ldquo;data structure&rdquo; which
      encodes the comments. The scheme module  give some classification of
      these two new elements:
    </p>
    <p>
      
    </p>
    <p>
      A new group of tags  is defined which contains both markup elements and
      they are declared as variants, and also as similar tags .
    </p>
    <p>
      On the procedural side, the available actions on comments, is made
      available to the user at the level of the editor via a set of scheme
      procedure in the  module. The procedure  creates a new comment in the
      current-buffer and at the current position
    </p>
    <p>
      
    </p>
    <p>
      Note the  procedure, which insert a given markup and also move the
      cursor at the position , meaning the 6th child of the inserted subtree,
      i.e. the body of the comment (which is an empty string), and there in
      position <span class="no-breaks"><img src="comments-in-texmacs-3.png" style="margin-left: -0.0248242424242424em; margin-bottom: -0.0269090909090909em; margin-right: -0.0248242424242422em; margin-top: -0.0310787878787879em; vertical-align: -0.258569696969697em; height: 1.09226666666667em"></img>,</span> ready for the user
      to fill in the comment.
    </p>
    <p>
      Basic operations on all the comments in a given document are provided by
      the following code
    </p>
    <p>
      
    </p>
    <p>
      In  the  loop cycle over all comments and according to the selected
      operation, it either convert all the node label to  or to , or in case ,
      just remove the associated subtree, i.e. remove the comment and all its
      data. Note that the enumeration of all the relevant comment elements is
      operated by the  function, which in turn uses  defined as:
    </p>
    <p>
      
    </p>
    <p>
      Finally, the functionalities are made available to the user via a menu
      and a shortcut in  thanks to the code
    </p>
    <p>
      
    </p>
    <p>
      which is loaded as soon as the package <tt>comment</tt> is used in the
      current document, as we have seen at the beginning of this article.
    </p>
    <p>
      
    </p>
    <p>
      We want to allow the user to see all the comments together. This is
      implemented via a &ldquo;virtual document&rdquo; which is generated on
      the fly using TeXmacs file system () interface. In  we find
    </p>
    <p>
      
    </p>
    <p>
      The most important instruction here is the call to  which defines an new
      type of resource within the TeXmacs file system . This introduces a new
      URI scheme <tt>tmfs://comments/<i>name</i></tt> where
      <tt><i>name</i></tt> is the name of the specific buffer for which we
      request the comments. When the user try to access this URI the handler
      is invoked and it returns a new document containing all the comments of
      the original document collected and processed via . This procedure
      replace the comment element with an element of kind  managing some
      additional metainformation in order to retrive the original comment
      within the document. Note also the user of  and  to set up various
      properties of the new comment URIs. The result is the following UI which
      appears to the uses as the  command is inkoved:
    </p>
    <p>
      <img class="image" src="comments-in-texmacs-4.png" width="100%"></img>
    </p>
    <p>
      The rendering of the  markup is specified in the <tt>comment</tt>
      package, of course:
    </p>
    <p>
      
    </p>
    <p>
      
    </p>
    <p>
      Ok, now things get serious. The actual implementation of  require some
      low-level tinkering in the typesetter. This will be fixed (hopefully) in
      the future, in such a way that the behaviour of the markup can be
      controlled via DRD declarations in the stylesheet language.
      Unfortunately this is not yet the case and we have to modify the C++
      code.
    </p>
    <p>
      The most basic change is to describe the behaviour of the markup with
      respect to multi-paragraph material. In  we have to modify the  function
      as follows:
    </p>
    <p>
      
    </p>
    <p>
      in particular note the line:
    </p>
    <p>
      
    </p>
    <p>
      This in order to make  override the default behaviour for non-primitive
      markup which is to return  if all the arguments returns  to .    
    </p>
    <p>
      We have also to modify :
    </p>
    <p>
      
    </p>
    <p>
      and :
    </p>
    <p>
      
    </p>
    <p>
      
    </p>
    <p>
      And finally 
    </p>
    <p>
      
    </p>
    <div class="toggle" style="display: none">
      dddd
    </div>
  </body>
</html>