<div class="globe-embed" id="{{ .Get "id" }}" style="height:{{ .Get "height" | default "460px" }};"></div>
<script src="https://unpkg.com/globe.gl"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script>
  (function () {
    const el = document.getElementById("{{ .Get "id" }}");
    if (!el) return;

    const globe = Globe()(el);
    globe
      .backgroundColor("rgba(0,0,0,0)")
      .showAtmosphere(false)
      .showGraticules(true);

    const themeConfig = {
      dark: {
        texture: "{{ .Get "textureDark" | default "https://unpkg.com/three-globe/example/img/earth-dark.jpg" }}",
        landColor: "{{ .Get "landColorDark" | default "#b8b8b8" }}",
        landSideColor: "{{ .Get "landSideColorDark" | default "#a8a8a8" }}",
        borderColor: "{{ .Get "borderColorDark" | default "#5f5f5f" }}",
        graticuleColor: "{{ .Get "graticuleColorDark" | default "rgba(255,255,255,0.15)" }}"
      },
      light: {
        texture: "{{ .Get "textureLight" | default "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='1' height='1'><rect width='1' height='1' fill='white'/></svg>" }}",
        landColor: "{{ .Get "landColorLight" | default "#2b2b2b" }}",
        landSideColor: "{{ .Get "landSideColorLight" | default "#1f1f1f" }}",
        borderColor: "{{ .Get "borderColorLight" | default "#6a6a6a" }}",
        graticuleColor: "{{ .Get "graticuleColorLight" | default "rgba(0,0,0,0.12)" }}"
      }
    };

    {{- $poles := .Site.Data.poles | default (slice) -}}
    const poleData = {{ $poles | jsonify | safeJS }};
    const pointColors = {
      geographic: {
        dark: "{{ .Get "geoColor" | default "#f2f2f2" }}",
        light: "{{ .Get "geoColorLight" | default "#1f1f1f" }}"
      },
      magnetic: {
        dark: "{{ .Get "magneticColor" | default "#ff6b6b" }}",
        light: "{{ .Get "magneticColorLight" | default "#c83c3c" }}"
      },
      geomagnetic: {
        dark: "{{ .Get "geomagneticColor" | default "#4ea3ff" }}",
        light: "{{ .Get "geomagneticColorLight" | default "#1f6fd1" }}"
      },
      inaccessibility: {
        dark: "{{ .Get "inaccessibilityColor" | default "#f2c14e" }}",
        light: "{{ .Get "inaccessibilityColorLight" | default "#b07c1a" }}"
      },
      ice: {
        dark: "{{ .Get "iceColor" | default "#7bd1c8" }}",
        light: "{{ .Get "iceColorLight" | default "#2b8a7d" }}"
      }
    };

    const points = poleData.map(pole => {
      const colors = pointColors[pole.id] || {};
      return {
        name: pole.name,
        lat: Number(pole.lat),
        lng: Number(pole.lng),
        colorDark: colors.dark || "#f2f2f2",
        colorLight: colors.light || "#1f1f1f"
      };
    });

    const resize = () => {
      const { width, height } = el.getBoundingClientRect();
      globe.width(Math.max(0, Math.floor(width)));
      globe.height(Math.max(0, Math.floor(height)));
    };

    resize();
    if (window.ResizeObserver) {
      new ResizeObserver(resize).observe(el);
    } else {
      window.addEventListener("resize", resize);
    }

    globe.pointOfView({ lat: 90, lng: 0, altitude: 2 });

    const root = document.documentElement;
    const prefersDark = () => window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    const getTheme = () => {
      const attr = root.getAttribute("data-theme");
      return attr === "dark" || attr === "light" ? attr : (prefersDark() ? "dark" : "light");
    };

    let countries = null;
    let currentTheme = getTheme();

    const applyTheme = theme => {
      const config = themeConfig[theme] || themeConfig.dark;
      globe.globeImageUrl(config.texture);
      if (typeof globe.graticulesColor === "function") {
        globe.graticulesColor(config.graticuleColor);
      }
      if (countries) {
        globe.polygonsData(countries)
          .polygonCapColor(() => config.landColor)
          .polygonSideColor(() => config.landSideColor)
          .polygonStrokeColor(() => config.borderColor)
          .polygonAltitude(0.01);
      }
      globe.pointsData(points.map(point => ({
        name: point.name,
        lat: point.lat,
        lng: point.lng,
        color: theme === "dark" ? point.colorDark : point.colorLight
      })));
    };

    const countriesUrl = "{{ .Get "countriesUrl" | default "https://unpkg.com/world-atlas@2/countries-110m.json" }}";
    fetch(countriesUrl)
      .then(res => res.json())
      .then(world => {
        countries = world.objects ? topojson.feature(world, world.objects.countries).features : world.features;
        applyTheme(currentTheme);
      })
      .catch(() => { });

    applyTheme(currentTheme);

    globe
      .pointLat(d => d.lat)
      .pointLng(d => d.lng)
      .pointColor(d => d.color)
      .pointRadius(0.4)
      .pointLabel(d => d.name);

    if (window.MutationObserver) {
      const observer = new MutationObserver(() => {
        const nextTheme = getTheme();
        if (nextTheme !== currentTheme) {
          currentTheme = nextTheme;
          applyTheme(currentTheme);
        }
      });
      observer.observe(root, { attributes: true, attributeFilter: ["data-theme"] });
    }
  })();
</script>
