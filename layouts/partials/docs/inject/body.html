<script>
  (() => {
    const storageKey = "theme";
    const root = document.documentElement;

    const applyTheme = theme => {
      root.setAttribute("data-theme", theme);
      root.style.colorScheme = theme;
      document.querySelectorAll("[data-theme-toggle]").forEach(btn => {
        const moon = btn.querySelector(".icon-moon");
        const sun = btn.querySelector(".icon-sun");
        if (moon) moon.style.display = theme === "dark" ? "none" : "block";
        if (sun) sun.style.display = theme === "dark" ? "block" : "none";
      });
    };

    const getStored = () => {
      try {
        return localStorage.getItem(storageKey);
      } catch (err) {
        return null;
      }
    };

    const setStored = value => {
      try {
        localStorage.setItem(storageKey, value);
      } catch (err) {}
    };

    const darkQuery = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)");

    const applyFromOS = () => applyTheme(darkQuery && darkQuery.matches ? "dark" : "light");

    const stored = getStored();
    if (stored === "light" || stored === "dark") {
      applyTheme(stored);
    } else {
      applyFromOS();
    }

    if (darkQuery) {
      darkQuery.addEventListener("change", () => {
        if (!getStored()) applyFromOS();
      });
    }

    document.addEventListener("click", event => {
      const button = event.target.closest("[data-theme-toggle]");
      if (!button) return;
      const current = root.getAttribute("data-theme") === "dark" ? "dark" : "light";
      const next = current === "dark" ? "light" : "dark";
      setStored(next);
      applyTheme(next);
    });
  })();
</script>
